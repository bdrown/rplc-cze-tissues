---
title: "Tissue Heatmaps"
output: html_notebook
---

```{r message=FALSE, warning=FALSE, include=FALSE}
# Load libraries

library(tidyverse)
library(biclust)
library(gplots)
library(RColorBrewer)
library(pheatmap)
```

A hit report was generated by TDviewer. The Hit Report includes many hits that 
correspond to PFRs that didn't pass the protein-level FDR cutoff. My solution
is to export the list of PFRs on the Proteoform tab of TDviewer and use this
list to filter the Hit Report.

```{r}
load("preprocessed.RData")
```


# Overall protein and proteoform distributions

```{r}
# Need to create a Tissue x PFR matrix with the spectral count as the value

pfrs <- hits %>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  group_by(Sample, PFR) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0)

m <- as.matrix(pfrs[2:ncol(pfrs)], rownames.force = F)
row.names(m) <- pfrs$PFR
n <- binarize(m, threshold=0)

# columns
col_distance <- dist(n, method = "binary")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(n), method = "binary")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("mediumorchid3", "black", "yellow"))(n = 299)

png(filename = "figures/PFR_PA_heatmap.png",
    width = 7, height = 6, units = "in", res = 300)
hm <- heatmap.2(t(n),
          main = "PFR Presence/Absence",  # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          key=F,
          margins = c(2,8),
          dendrogram="row", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F)
dev.off()
```

```{r}
# Need to create a Tissue x PFR matrix with the spectral count as the value

pfrs <- hits %>%
  filter(num_fragments > 3 | Modification_Codes == "") %>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  group_by(Sample, PFR) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0)

m <- as.matrix(pfrs[2:ncol(pfrs)], rownames.force = F)
row.names(m) <- pfrs$PFR
n <- binarize(m, threshold=0)

# columns
col_distance <- dist(n, method = "binary")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(n), method = "binary")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("mediumorchid3", "black", "yellow"))(n = 299)

png(filename = "figures/PFR_PA_heatmap_filtered.png",
    width = 7, height = 5, units = "in", res = 300)
hm <- heatmap.2(t(n),
          main = "PFR Presence/Absence Num Frag >2",  # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          key=F,
          margins = c(2,8),
          dendrogram="both", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F)
dev.off()
```


```{r}

pfrs <- hits %>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  group_by(Sample, PFR) %>%
  summarise(Count = n() + 0.01) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0.51)

m <- m - 0.01

m <- as.matrix(pfrs[2:ncol(pfrs)], rownames.force = F)
row.names(m) <- pfrs$PFR

# columns
col_distance <- dist(log2(m), method = "manhattan")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(log2(m)), method = "manhattan")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("white", "black"))(n = 299)

png(filename = "figures/PFR_SPC_heatmap.png",
    width = 7, height = 5, units = "in", res = 300)
hm <- heatmap.2(log2(t(m)),
          main = "PFR Spectral Count",  # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          #scale = "row",
          margins = c(2,8),
          dendrogram="both", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F,
          key.xlab = "log2(SPC)",
          symm=F,symkey=F,symbreaks=F)
dev.off()

```


```{r}
# Need to create a Tissue x PFR matrix with the spectral count as the value

protein <- hits %>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  group_by(Sample, Accession) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0)

m <- as.matrix(protein[2:ncol(protein)], rownames.force = F)
row.names(m) <- protein$Accession
n <- binarize(m, threshold=0)

# columns
col_distance <- dist(n, method = "binary")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(n), method = "binary")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("mediumorchid3", "black", "yellow"))(n = 299)

png(filename = "figures/Protein_PA_heatmap.png",
    width = 7, height = 5, units = "in", res = 300)
hm <- heatmap.2(t(n),
          main = "Protein Presence/Absence",  # heat map title
          xlab = "Proteins",
          ylab = "Tissue Samples",
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          key=F,
          margins = c(2,8),
          dendrogram="both", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F)
dev.off()
```

```{r}
protein <- hits %>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  group_by(Sample, Accession) %>%
  summarise(Count = n() + 0.01) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0.51)

m <- as.matrix(protein[2:ncol(protein)], rownames.force = F)
row.names(m) <- protein$Accession
m <- m - 0.01

# columns
col_distance <- dist(log2(m), method = "manhattan")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(log2(m)), method = "manhattan")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("white", "black"))(n = 299)

png(filename = "figures/Protein_SPC_heatmap.png",
    width = 7, height = 5, units = "in", res = 300)
hm <- heatmap.2(log2(t(m)),
          main = "Protein Spectral Count",  # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          #scale = "row",
          margins = c(2,8),
          dendrogram="both", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F,
          key.xlab = "log2(SPC)",
          symm=F,symkey=F,symbreaks=F)
dev.off()

```

```{r}
protein <- hits %>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  dplyr::select(Sample, Accession, PFR) %>%
  unique() %>%
  group_by(Sample, Accession) %>%
  summarise(Count = n() + 0.01) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0.51)

m <- as.matrix(protein[2:ncol(protein)], rownames.force = F)
row.names(m) <- protein$Accession
m <- m - 0.01

# columns
col_distance <- dist(log2(m), method = "manhattan")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(log2(m)), method = "manhattan")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("white", "black"))(n = 299)

png(filename = "figures/Protein_PFRcount_heatmap.png",
    width = 7, height = 5, units = "in", res = 300)
hm <- heatmap.2(log2(t(m)),
          main = "Protein Proteoform Count",  # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          #scale = "row",
          margins = c(2,8),
          dendrogram="both", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F,
          key.xlab = "log2(# PFRs)",
          symm=F,symkey=F,symbreaks=F)
dev.off()

```

# Top Proteins by PFR Count

Which proteins in each tissue have the most annotated proteoforms?

```{r}
proteins_top <- hits %>%
  dplyr::select(Tissue, Uniprot_Id, PFR, Description) %>%
  unique() %>%
  group_by(Tissue, Uniprot_Id, Description) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Tissue", values_from = "Count", values_fill = 0)

write_delim(proteins_top, "output_data/top_proteins_by_pfr_count.tsv", delim="\t")

```


# Shared proteins
Here we're looking at proteoforms from proteins that are shared by at least
two tissue types

```{r}
protein <- hits %>%
  group_by(Tissue, Accession) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Tissue", values_from = "Count", values_fill = 0)
m <- as.matrix(protein[2:ncol(protein)], rownames.force = F)
row.names(m) <- protein$Accession
n <- binarize(m, threshold=0)

sums <- rowSums(n) %>%
  as.data.frame()
sums$Accession <- rownames(n)
colnames(sums) <- c("Num_Tissues", "Accession")

png(filename = "figures/Protein_Sharing_xTissue.png",
    width = 5, height = 5, units = "in", res = 300)
ggplot(sums, aes(x= Num_Tissues)) +
  geom_bar() +
  labs(title = paste0("Proteins Identified Across Tissues (", nrow(sums), " proteins total)"),
       x = "Identified in # Tissues",
       y = "Number of Proteins") +
  theme_bw()
dev.off()

protein_shared <- sums %>%
  filter(Num_Tissues > 2)

pfrs <- hits %>%
  filter(Accession %in% protein_shared$Accession)%>%
  mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
  group_by(Sample, PFR) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0)

m <- as.matrix(pfrs[2:ncol(pfrs)], rownames.force = F)
row.names(m) <- pfrs$PFR
n <- binarize(m, threshold=0)

# columns
col_distance <- dist(n, method = "binary")
col_cluster <- hclust(col_distance, method = "ward.D2")

# rows
row_distance <- dist(t(n), method = "binary")
row_cluster <- hclust(row_distance, method = "ward.D2")

# creates a own color palette from red to green
my_palette <- colorRampPalette(c("mediumorchid3", "black", "yellow"))(n = 299)

png(filename = "figures/Shared_Protein_PFR_PA_heatmap_reps.png",
    width = 7, height = 5, units = "in", res = 300)
hm <- heatmap.2(t(n),
          main = "Proteins in >2 Tissues \nPFR Presence/Absence",  # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          col=my_palette,       # use on color palette defined earlier
          key=F,
          margins = c(2,8),
          dendrogram="both", 
          Rowv = as.dendrogram(row_cluster),
          Colv = as.dendrogram(col_cluster),
          labCol = F)
dev.off
```

## Distribution of PFRs from shared proteins

TODO: Generate a heatmap figure in which PFRs are groups by isoform. Possibly use pheatmap
https://stackoverflow.com/questions/41608294/r-heatmap-2-manual-grouping-of-rows-and-columns
```{r}

pfrs <- hits %>%
  filter(Accession %in% protein_shared$Accession)%>%
  mutate(Uniprot_Id = ifelse(PFR == 256951, "H2A2C_HUMAN", Uniprot_Id)) %>%
  group_by(Tissue, Uniprot_Id, PFR) %>%
  summarise(Count = n()) %>%
  pivot_wider(names_from = "Tissue", values_from = "Count", values_fill = 0) %>%
  arrange(Uniprot_Id) %>%
  unique()

m <- as.matrix(pfrs[3:ncol(pfrs)], rownames.force = F)
row.names(m) <- pfrs$PFR
n <- binarize(m, threshold=0)


# Annotations
# Row names must match PFR numbers
# Only column will be uniprot accession

col_anno <- data.frame(Gene = pfrs$Uniprot_Id)
row.names(col_anno) <- make.names(pfrs$PFR, unique = TRUE)

genes_u <- unique(col_anno$Gene) # list of unique genes

# Can only really see 18 genes at a time
# Color brewer has a pallete that maxes out at 12 levels
genes_per_fig <- 12
num_figs <- ceiling(length(genes_u) / genes_per_fig)

save_hm_png <- function(x, filename, w = 5, h = 5, res = 300){
  png(filename = filename, width = w, height = h, res = res, units = "in")
  grid::grid.newpage()
  grid::grid.draw(x$gtable)
  dev.off()
}

start <- 1
for(i in seq(from = 1, to = num_figs)) {
  current_genes <- genes_u[start:(start + genes_per_fig - 1)]
  print(current_genes)
  start <- start + genes_per_fig
  
  df <- pfrs %>%
    filter(Uniprot_Id %in% current_genes)

  m <- as.matrix(df[3:ncol(df)], rownames.force = F)
  row.names(m) <- make.names(df$PFR, unique = TRUE)
  n <- binarize(m, threshold=0)
  
  col_anno <- data.frame(Gene = pfrs$Uniprot_Id)
  row.names(col_anno) <- make.names(pfrs$PFR, unique = TRUE)
  
  hm <- pheatmap(n, annotation_row = col_anno,
           cluster_rows = F, cluster_cols = F,
           legend=F,
           show_rownames = F)
  save_hm_png(hm, paste0("figures/PFR_groupedByGene_", i, ".png"), 3, 7)
}

```

# Focused looks

Let's build a SPC heatmap of a handful of proteoforms from proteins that are kind
of interesting.

```{r}
poi <- c("ATIF1_HUMAN", "DEF1_HUMAN", "MGST1_HUMAN", "MGST2_HUMAN", "SODC_HUMAN",
         "TPIS_HUMAN", "SERP1_HUMAN", "SC61B_HUMAN", "SAA1_HUMAN", "ADIRF_HUMAN",
         "ARF1_HUMAN")

for(p in poi) {
  pfrs <- hits %>%
    filter(Uniprot_Id == p) %>%
    mutate(Sample = paste0(Tissue,"-", Separation, "-", Biorep)) %>%
    group_by(Sample, PFR) %>%
    summarise(Count = n() + 0.01) %>%
    pivot_wider(names_from = "Sample", values_from = "Count", values_fill = 0.51)

  m <- m - 0.01
  
  m <- as.matrix(pfrs[2:ncol(pfrs)], rownames.force = F)
  row.names(m) <- pfrs$PFR
  
  # columns
  col_distance <- dist(log2(m), method = "manhattan")
  col_cluster <- hclust(col_distance, method = "ward.D2")
  
  # rows
  row_distance <- dist(t(log2(m)), method = "manhattan")
  row_cluster <- hclust(row_distance, method = "ward.D2")
  
  # creates a own color palette from red to green
  my_palette <- colorRampPalette(c("white", "black"))(n = 299)
  
  png(filename = paste0("figures/PFR_SPC_",p,".png"),
    width = 7, height = 5, units = "in", res = 300)
  hm <- heatmap.2(log2(t(m)),
            main = paste0("PFR Spectral Count\n", p),  # heat map title
            notecol="black",      # change font color of cell labels to black
            density.info="none",  # turns off density plot inside color legend
            trace="none",         # turns off trace lines inside the heat map
            col=my_palette,       # use on color palette defined earlier
            #scale = "row",
            margins = c(8,8),
            dendrogram="both", 
            Rowv = as.dendrogram(row_cluster),
            Colv = as.dendrogram(col_cluster),
            key.xlab = "log2(SPC)",
            symm=F,symkey=F,symbreaks=F)
  dev.off()
}

hits %>%
  filter(Accession == "Q15847") %>%
  dplyr::select(PFR, Accession, Sequence, Modifications) %>%
  unique() %>%
  arrange(PFR)
```


```{r}
png(filename = paste0("figures/MassVsTimeBySepByFrac.png"),
    width = 12, height = 4, units = "in", res = 300)
hits %>%
  filter(Tissue %in% c("Heart", "Spleen", "SmInt")) %>%
  group_by(PFR, Tissue, Separation, Fraction) %>%
  summarise(Mass = mean(Monoisotopic_Mass), Time = mean(Average_Retention_Time)) %>%
  ggplot(aes(y = Mass, x = Time, color = Separation)) +
  geom_point() +
  facet_grid(Separation~Fraction) +
  theme_bw()
dev.off()

hits %>%
  #filter(Tissue %in% c("Heart", "Spleen", "SmInt")) %>%
  ggplot(aes(x = factor(Fraction), y = Monoisotopic_Mass, fill = Separation)) +
  geom_violin(scale="width", draw_quantiles = 0.5) +
  facet_grid(~Separation) +
  labs(title = "Mass Distribution in Fractions Scaled by SPC") +
  theme_bw()
  
hits %>%
  #filter(Tissue %in% c("Heart", "Spleen", "SmInt")) %>%
  group_by(PFR, Separation, Fraction) %>%
  summarise(Monoisotopic_Mass = mean(Monoisotopic_Mass)) %>%
  ggplot(aes(x = factor(Fraction), y = Monoisotopic_Mass, fill = Separation)) +
  geom_violin(scale="width", draw_quantiles = 0.5) +
  facet_grid(~Separation) +
  labs(title = "Mass Distribution in Fractions Not Scaled") +
  theme_bw()



```
